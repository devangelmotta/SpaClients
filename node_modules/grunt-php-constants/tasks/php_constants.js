/*
 * grunt-php-constants
 * https://github.com/davemedema/grunt-php-constants
 *
 * Copyright (c) 2013 Dave Medema
 * Licensed under the MIT license.
 */

 'use strict';

 module.exports = function(grunt) {

  grunt.registerMultiTask('php_constants', 'Update named constants in PHP files.', function() {
    // Merge task-specific and/or target-specific options with these defaults.
    var options = this.data.options;
    // Validate source file
    var srcFile = this.data.src;
    if (!srcFile) {
      grunt.log.warn('Source file is required.');
      return false;
    }

    if (!grunt.file.exists(srcFile)) {
      grunt.log.warn('Source file "' + srcFile + '" not found.');
      return false;
    }


    // Init regex
    var pattern = [];
    var regexp = [];
    var constValue = [];
    var constName = [];

    for(let i = 0; i < options.length; i++){
      pattern.push('define\\s*\\(\\s*[\'"]' + options[i].constName + '[\'"]\\s*,\\s*[\'"].*?[\'"]\\s*\\)\\s*;');
      regexp.push(new RegExp(pattern[i]));
    }
    
    // Validate presence of the constant in the source file
    var src = grunt.file.read(srcFile);

    // Set destination file
    var destFile = (this.data.dest || srcFile);

    // Update source and write destination file
    for(let i = 0; i < options.length; i++){
      constName.push(options[i].constName);
      constValue.push(options[i].constValue);
    }

    for(let i = 0; i < constValue.length; i++){
      var php = "define('{name}', '{value}');";
      php = php.replace('{name}', options[i].constName);
      php = php.replace('{value}', options[i].constValue);
      src = src.replace(regexp[i], php);
    }
    grunt.file.write(destFile, src);
  });

};
